\documentclass[a4paper,12pt,twoside]{book}
\usepackage[english]{babel}
\usepackage{blindtext}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{apacite}
\usepackage{natbib}
\usepackage{url}
\usepackage{amsmath,amssymb,amsfonts}

\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xcolor}
\usepackage{dirtytalk}

\graphicspath{ {.} }

\usepackage{listings}
\usepackage{xcolor}

\usepackage{balance}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
    }

    \lstset{style=mystyle}
    
\bibliographystyle{apacite}
\pagestyle{myheadings}
\title{ City traffic, IoT and Blockchain technologies }
\author{Toma Becea}

\begin{document}

\maketitle

\clearpage

\section{Introduction}

    Following previous chapter, about how traffic in a city can be modeled and analyzed, we step forward into the realm of IoT and Blockchain technologies. Those two terms, IoT and Blockchain, are only buzz words. Or they are so general, so loosely defined that we can treat them as marketing or advertising terms. Hence, we have to define them for our specific purpose.

    Internet of Things is term coined to express the multitude of devices or physical objects which are connected, in various ways, to the public internet. They are transmitting data, are requesting data from a central server, one from another or in collaboration with a mesh of IoT devices. An IoT device has something to "offer". It is usually a specific job it has to do by being provided with sensors and a alogrithmical method of sending data. On the other hand it can be also used for automation jobs where not only it is able to send data to other systems but it can act based upon the data it acquires or it can receive various commands to execute from other IoT devices or systems. In the context of the present thesis an IoT device can be considered an actor which is travelling thorugh the city and it reports data or it uses other actor's data.

    Blockchain are a set of emerging technologies which were first aimed at decentralizing financial transactions. Bitcoin cryptocurrency\citep{SatoshiNakamoto}, first of its kind and still the most popular, created a global distributed and decentralized peer to peer system where financial transactions (sending money from one account or wallet to another one) are taking place without relying to a central party or a bank for shielding against double spend \citep{DoubleSpend}. It also sparked a cornucopia of other cryptocurrencies, each with its own distinctive feature. Few of them, worth to be noted because they will be analyzed further in this thesis, are Ethereum, Hyperledger Fabric and IOTA.

\section{Abstract}

    This chapter is aiming to lay the ground on how we intend to bring the city traffic infrastructure from previous chapter and its needs into a blockchain technology. The two worlds, two very different paradigms, can be bridged together: IoT and Blockchain. The traffic of a city is an inherent IoT application. The actors, regardless of their type (cars, bikes, pedestrians), might have limited power consumption, might have intermittent internet conectivity and can be offline for long periods of time. Those constraints led to design an IoT solution for their communications. On the other side a Blockchain technology has needs which, at first sight, are in contrast with what an IoT device can do: proof of work is the first reason as it requires a great amount of power. Then the continuous online presence is needed, to participate in the blockchain network and stay up to date. Last, but not the least, the smart contracts nature of each Blockchain requires a different paradigm, a shift in how business logic are written. This comes with its own set of opportunities and limitations. To bring those areas together gaps must be identified in detail and bridges must be built over them. The target is to discuss those areas for two blockchains networks: Ethereum 2.0 and IOTA.

\section{Introduction}
\label{sec:sec}

    The journey of this chapter follows the items below. We first establish what IoT means for the city traffic simulation from chapter one. Several concepts from it will be repeated but from a different perspective. This happens in section \ref{sec:IoTNature}. Afterwards few aspects from Ethereum 2.0 blockchain will be discussed, in section \ref{sec:EthereumNature}. Same perspective but with a different blockcahin will be in section \ref{sec:IOTABlockchainNature}. Both of them have various proposals around smart contracts executioon and this will be discussed in section \ref{sec:SmartContracts}. A big part of every distributed ledger is the way it has designed its Proof of Work or Proof of Stake. Those will be discussed in section \ref{sec:PoWandPoS}. Finally, the two worlds will be connected using few proposals in section \ref{sec:GapsBridges}.

    \begin{itemize}
        \item The IoT nature of the actors from a city traffic
        \item The Blockchain nature of Ethereum 2.0
        \item The Blockchain nature of IOTA
        \item Smart contracts
        \item Proof of Work and Proof of Stake
        \item Gaps and bridges
        \item Conclusion
    \end{itemize}


\section{The IoT nature of the actors from a city traffic}
\label{sec:IoTNature}

    IoT is a very general concept with many dimensions. Across the type of applications dimension there are several domains like, but not limited to, consumer applications (e.g. smart home), medical and healthcare, industrial (e.g. agriculture), military, etc. On the dimension of physical connection, they can use bluetooth, near-field communication or wifi. Therefore the effort of defining the general nature of IoT is quite extensive and doesn't fit into current subject.

    What we can achieve here, however, is to define the nature of the actors participating in a traffic city (or in a simulation, see previous chapter). The walkthrough of this has to reach few points:

    \begin{itemize}
        \item Hardware
        \item Communication layer
        \item Communication style
        \item Security
        \item Anonimity
        \item Interoperability
    \end{itemize}

    \paragraph{Hardware} Traditionally a person which travels within a city is expected to have a standalone GPS or a smartphone with GPS abilities and a suitable application (e.g. Waze). For our purposes the hardware is a less important choice. What matters is that the software running is able to send data, receive data and act accordingly for informing the user. Given the decentralized architecture this thesis is going towards, a classic navigation application (like Waze, which depends on a server to be fully functionally) is less likely to fit. Therefore a custom software stack needs to run. With respect to how much powerfull the navigation device is, there is a plethora of options, ranging from low energy to high performing CPUs and GPUs. This enables the navigation device to be able to run smart contracts and proof of work activities. \ref{sec:PoWandPoS} will talk more on this subject.

    \paragraph{Communication layer} The first assumption is that the device is able to send and receive data via a TCP based protocol. The second assumption is that the bandwith is enough to send and receive packets which have JSON format.

    \paragraph{Communication style} To explain the style of communications for an actor the best way is to illustrate it using two JSON examples. Following \cite{MicroservicesCityTrafficSimulation} paper about a microservices approach for city traffic simulation, we take and use the data defined there for defining the communication style. Listings \ref{lst:jsonClientEnums} shows the JSON schema for a report which an actor sends (in the cited paper it sends this message to a central server but the intention of the thesis is to have a decentralized architecture and no central servers). \textit{ReportOnTheLine} is the report sent by one agent to notify the city that he is currently advancing through one line. \textit{ReportOffFromLine} is the report sent by one agent to notify the city that he has finished advancing through one line and has departed from it. \textit{SendReport} is a message passed from an actor to the city indicating its status (e.g. location). \textit{AskForLine} is a message passed from an actor to the city. A response is awaited. \textit{RespondWithLine} is a message passed from the city to an actor and it contains line data.

    \begin{lstlisting}[caption=JSON schema with enumerations for messaging, label=lst:jsonClientEnums]
    "ReportType": {
        "type": "array",
        "items": {
            "type": "string",
            "enum": ["ReportOnTheLine", 
                        "ReportOffFromLine"]
        }
    },
    
    "MessageType": {
        "type": "array",
        "items": {
            "type": "string",
            "enum": ["SendReport",
                        "AskForLine", 
                        "RespondWithLine"]
        }
    }            
    \end{lstlisting}

    \begin{lstlisting}[caption=JSON top level struct (envelope), label=lst:jsonEnvelope]        
    "Envelope": {
        "MessageType": "SendReport
        "Payload": {
            "ReportType": "ReportOffFromLine",
            "Line": [ { 45.64354, 34.6768 }, 
                        { 45.66543, 34.6722 }
            ]
        }
    }
    \end{lstlisting}

    The global format of such a JSON has the ability to transport any type of message. Therefore the listing \ref{lst:jsonEnvelope} represents such a message. The envelope, on its turn, contains another message, of different formats. Listing \ref{lst:jsonClientEnums} shows one example of such a contained message. It is the way a client reports one line it is travelling onto or one line it has just finished travelling. Both listings, \ref{lst:jsonEnvelope} and \ref{lst:jsonClientEnums}, show json schema messages. 
    
    Another aspect of those messages is that an actor can send a message of type \textit{AskForLine} and afterwards it is expecting a message back with details about that line (e.g. how many other actors are travelling on it). The question of uttermost importance is: to whom does it send this message? In \cite{MicroservicesCityTrafficSimulation} the authors use a \textit{central server} and each actor is communicating only with it. However, having already set a foot into the world of decentralized systems, we do not have anymore a \textit{central server}. A decentralized ledger or blockchain or system, soon to be discussed in \ref{sec:EthereumNature}, has no such concept of \textit{server}. For the moment of this paragraph which is concerned only with the way an actor is communicating, we can assume that there are two components: the \textit{frontend} one and the \textit{backend} one. The \textit{frontend} one is concerned with showing information to the user (graphical, text, etc.) and also computing (via classic algorithms or Artifical Intelligence algorithms) the things which a user needs (e.g. shortest or fastest path from one point to another). To obtain various benefits along those computations there are certain types of information which have to be obtained. There is static information like the map of the city where the actor is in and there is dynamic information about what is currently, at the time of the computation or at the certain and precisely known time in the future, happening in the city. One reiterated example is how many actors are already on a certain line in the city. Having this information for the lines which would represent one of the paths the querying actor can run onto, the computations can compute more accurately a shorter (time wise) path or it can optimize various other outcomes. So far this has been the \textit{frontend}. The other part is the \textit{backend}. This is concerned less with how the data is presented to the user and how the computations are working. Its concerns are how to obtain the data needed by the \textit{frontend} and how to serve it. Thus it can be a server where all the actors are calling into. But it also can be one of the peers which are part of a decentralized network like Ethereum or IOTA. It can take care of all the nitty-gritty parts. It can compile various types of data, it can run necessary validations which are mandatory in such types of networks and so on. More details about how it does this are not part of this paragraph or of this chapter but they will be discussed later on on this thesis. Such distinctions between \textit{frontend} and \textit{backend} can also been seen in \cite{ApproachesToFrontEnd} where, among few options, there are standalone nodes responsible for participating into the network and a \say{local device} which offers \say{local} functionalities for various applications.

    \paragraph{Security} The security is not a concern at this stage. The commmunications between the \textit{frontend} and the \textit{backend} have been described above only with respect to the form of communication. Any other aspects like encryption, certificates will be part of next sections.

    \paragraph{Anonimity} In the client server architecture 
    \citep{MicroservicesCityTrafficSimulation} the server does not need to maintain an identity of the clients which it has to communicate with. In order to keep an accurate list of how various lines and their load any client is required to send a report where it signals that it finished the traveling through a line. This can be seen in listing \ref{lst:jsonClientEnums}, first message type called \textit{ReportOffFromLine}. The momentarily assumption is that the clients are correctly behaving and are not actively trying to introduce unwanted effects into the wider network, nor to mislead the server about their position. Such enforcments, of mandatory good behavior, are modeled through mechanisms like Proof of Work and Proof of Stake and will be discussed in section \ref{sec:PoWandPoS}. The other aspect which can naturally occur is when a client, altough it has good intentions to send a \textit{ReportOffFromLine} message, it is not able to due to dropped connections or any other reason outside its control. A server might need, in this case, to implement a mechanism of timeouts for \textit{ReportOnTheLine}. In order to know which message to timeout it should keep an identification token for each client. This is one of the solutions. Knowing the average time to travel the respective line it can safely asssume that if there is no sign from that client within a reasonable and configurable time, it can dequeue its load.

    \paragraph{Interoperability} The plethora of programming languages, frameworks, runtimes and operating systems give a multitude of choices of where and how to run such clients and servers. So far nothing has been discussed regarding this aspect. The only place where we can see an implementation of a client server architecture, as presented in this section, is \cite{MicroservicesCityTrafficSimulation}. Programming language is Golang, the UI is made using web technologies like HTMl and JavaScript, together with various frameworks or libraries for ease of development (a library called Gorilla for working with WebSockets in Golang, OpenSourceMap and OpenLayers for displaying and manipulating maps in the browser, etc.). However, despite all those fine grained choices, the one which assures the interoperability is the ubiquity of JSON formats. Every language supports it and every language knows how to encode its internal data structures into a JSON format. Or how to decode them. Thus listings \ref{lst:jsonClientEnums} and \ref{lst:jsonEnvelope} are presented in as JSON messages schema. They also represents a small part of wannabe protocol.

\section{The Blockchain nature of Ethereum 2.0}
\label{sec:EthereumNature}



    \paragraph{Security} Security in Ethereum is a complex process. If an account, being a user's account or a contract account, has successfully secured the private signing key, it is assured that no one can simulate it and no one can execute transactions on its behalf. Known breaches have always occured in the same way: private keys have been leaked and malicious actors were able to execute transactions with them.
    An approach in securing IoT networks is described in \cite{SecureCommunicatingThingsNetworkFramework}. The aim is to ensure secure product shipment, as well as connecting manufacturing locations from different geographical locations. They have a front end for human interactions and a back end for the internal communication of the blockchain network. In the blockchain networks there are two types of associates, the authentication nodes also known is miners and execution nodes. The authentication nodes take care of validating new transactions and keeping up to date with the ever growing blockchain in which they participate. The executing nodes are watching accumulating values and verify their validity. The authors are considering various scenarios like traceability of product records, illegal activities made by workers or shippments. Transactions like those are always embedding the previous block's hash, providing a secure way around manipulating 

\section{The Blockchain nature of IOTA}
\label{sec:IOTABlockchainNature}

\section{Smart contracts}
\label{sec:SmartContracts}

\section{Proof of Work and Proof of Stake}
\label{sec:PoWandPoS}

% good behavior

\section{Gaps and Bridges}
\label{sec:GapsBridges}

\section{Conclusion}
\label{sec:Conclusion}

\bibliography{wiki}

\end{document}
